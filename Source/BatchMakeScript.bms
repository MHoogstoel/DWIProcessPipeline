
if( ${ROOTNAME} == '' ) Then
  Set( ROOTNAME ${INPUT} )
EndIf( ${ROOTNAME} == '' )

Set( TEMPDIR ${OUTPUTDIR}/temp )
If( ${INPUTTYPE} == 'DWI' )
  Set( DWImage ${INPUT}.${EXT} )
  Set( DTI_DIR ${OUTPUTDIR} )
  Set( DTImage ${ROOTNAME}_dti_f.nrrd )
  Set( B0_EXT nrrd )
  Set( B0 ${ROOTNAME}_b0.${B0_EXT} )
  Set( IDWImage ${ROOTNAME}_idwi.nrrd )
  Set( RESAMPLED_IMAGE ${ROOTNAME}_dti_f_reg.nrrd )
else( ${INPUTTYPE} == 'DWI' )
  Set( RESAMPLED_IMAGE ${ROOTNAME}_reg.nrrd )
  Set( DWImage '' )
  Set( IDWImage '' )
  Set( DTI_DIR ${INPUTDIR} )
  If( ${INPUTTYPE} == 'DTI' )
    Set( DTImage ${INPUT}.${EXT} )
    Set( B0 '' )
  Else( ${INPUTTYPE} == 'DTI' )
    Set( DTImage '' )
    Set( B0 ${INPUT}.${EXT} )
    Set( B0_EXT ${EXT} )
  Endif( ${INPUTTYPE} == 'DTI' )
Endif( ${INPUTTYPE} == 'DWI' )

echo( ${TRANSFORMATIONFILE})
echo(${REGTYPE})
include( Prepare.bms )
If( ${TRANSFORMATIONFILE} == '' )
  Set( GIVEN_TRANSFORM FALSE )
  Set( TRANSFORMATIONFILE ${ROOTNAME}_reg.mat )
  if(${InitialTransform} != '' && ${SCALE} != TRUE )
    Set( TRANSFORMFILE ${TEMPDIR}/${TRANSFORMATIONFILE} )
  else(${InitialTransform} != ''  && ${SCALE} != TRUE )
    Set( TRANSFORMFILE ${OUTPUTDIR}/${TRANSFORMATIONFILE} )
  endif(${InitialTransform} != ''  && ${SCALE} != TRUE )
  Set( TransformRelativePATH ${TRANSFORMATIONFILE} )
  include( Registration.bms )
Else( ${TRANSFORMATIONFILE} == '' )
  Set( GIVEN_TRANSFORM TRUE )
  Set( TRANSFORMFILE ${TRANSFORMATIONFILE} )
  if( ${SKULLSTRIP} == TRUE )
    include( MaskImage.bms )
  endif( ${SKULLSTRIP} == TRUE )
Endif( ${TRANSFORMATIONFILE} == '' )
include( Transform.bms )
If( ${INPUTTYPE} == 'DWI' || ${INPUTTYPE} == 'DTI' )
  include( PostProcessing.bms )
Endif( ${INPUTTYPE} == 'DWI' || ${INPUTTYPE} == 'DTI' )
echo( 'before CreateMRML')
if( ${CreateMRMLPATH} != '' )
  include( CreateMRMLScene.bms )
endif( ${CreateMRMLPATH} != '' )
echo( 'after CreateMRML')
